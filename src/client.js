import { __awaiter } from "tslib";
import { v4 as uuidv4 } from 'uuid';
import SockJS from 'sockjs-client';
import OutputWriter from './output-writer';
export default class Client {
    constructor(settings) {
        this.serverUrl = settings.serverUrl;
        this.queue = [];
        this.outputWriters = {};
    }
    connect() {
        return new Promise((resolve, reject) => {
            if (this.connected) {
                return reject();
            }
            this.connected = false;
            this.sessionId = "";
            this.cellSessionId = uuidv4();
            this.queue = [];
            this.outputWriters = {};
            this.ws = null;
            fetch(this.getKernelUrl(), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            }).then(response => response.json())
                .then((data) => {
                this.sessionId = data.id;
                this.ws = new SockJS(this.getWSUrl());
                this.ws.onopen = () => {
                    this.connected = true;
                    resolve();
                };
                this.ws.onmessage = (msg) => { this.handleReply(msg); };
                this.ws.onclose = () => { this.disconnect(); };
                this.ws.onerror = () => { this.disconnect(); };
            }).catch((e) => {
                this.disconnect();
                reject(e);
            });
        });
    }
    enqueue(code, outputEl) {
        const msgId = uuidv4();
        const payload = JSON.stringify({
            header: {
                msg_id: msgId,
                username: "",
                session: this.cellSessionId,
                msg_type: 'execute_request',
            },
            metadata: {},
            content: {
                code: code,
                silent: false,
                user_variables: [],
                user_expressions: {
                    "_sagecell_files": "sys._sage_.new_files()",
                },
                allow_stdin: false
            },
            parent_header: {}
        });
        this.outputWriters[msgId] = new OutputWriter(outputEl);
        this.queue.push(payload);
    }
    send() {
        const payload = this.queue.shift();
        this.ws.send(`${this.sessionId}/channels,${payload}`);
    }
    handleReply(msg) {
        return __awaiter(this, void 0, void 0, function* () {
            const data = JSON.parse(msg.data.substring(46));
            const msgType = data.header.msg_type;
            const msgId = data.parent_header.msg_id;
            const content = data.content;
            if (msgType == 'stream' && content.text) {
                this.outputWriters[msgId].appendText(content.text);
            }
            if (msgType == 'execute_result' && content.data['text/plain']) {
                this.outputWriters[msgId].appendText(content.data['text/plain']);
            }
            if (msgType == 'display_data' && content.data['text/image-filename']) {
                this.outputWriters[msgId].appendImage(this.getFileUrl(content.data['text/image-filename']));
            }
            if (msgType == 'display_data' && content.data['text/html']) {
                this.outputWriters[msgId].appendSafeHTML(content.data['text/html'].replace("cell://", this.getFileUrl("")));
            }
            if (msgType == 'error') {
                this.outputWriters[msgId].appendError(content);
            }
            if (msgType == 'execute_reply') {
                if (this.queue.length > 0) {
                    this.send();
                }
                else {
                    this.disconnect();
                }
            }
        });
    }
    disconnect() {
        return new Promise((resolve, reject) => {
            if (this.ws)
                this.ws.close();
            this.connected = false;
            this.sessionId = "";
            this.cellSessionId = "";
            this.outputWriters = {};
            this.ws = null;
            resolve();
        });
    }
    getKernelUrl() {
        return `${this.serverUrl}/kernel?CellSessionID=${this.cellSessionId}&timeout=inf`;
    }
    getWSUrl() {
        return `${this.serverUrl}/sockjs?CellSessionID=${this.cellSessionId}`;
    }
    getFileUrl(file) {
        return `${this.serverUrl}/kernel/${this.sessionId}/files/${file}`;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2xpZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiY2xpZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsRUFBRSxJQUFJLE1BQU0sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNwQyxPQUFPLE1BQU0sTUFBTSxlQUFlLENBQUM7QUFDbkMsT0FBTyxZQUFZLE1BQU0saUJBQWlCLENBQUE7QUFFMUMsTUFBTSxDQUFDLE9BQU8sT0FBTyxNQUFNO0lBU3pCLFlBQVksUUFBYTtRQUN2QixJQUFJLENBQUMsU0FBUyxHQUFHLFFBQVEsQ0FBQyxTQUFTLENBQUM7UUFDcEMsSUFBSSxDQUFDLEtBQUssR0FBRyxFQUFFLENBQUM7UUFDaEIsSUFBSSxDQUFDLGFBQWEsR0FBRyxFQUFFLENBQUM7SUFDMUIsQ0FBQztJQUVELE9BQU87UUFDTCxPQUFPLElBQUksT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFO1lBQ3JDLElBQUksSUFBSSxDQUFDLFNBQVMsRUFBRTtnQkFBRSxPQUFPLE1BQU0sRUFBRSxDQUFDO2FBQUU7WUFFeEMsSUFBSSxDQUFDLFNBQVMsR0FBRyxLQUFLLENBQUM7WUFDdkIsSUFBSSxDQUFDLFNBQVMsR0FBRyxFQUFFLENBQUM7WUFDcEIsSUFBSSxDQUFDLGFBQWEsR0FBRyxNQUFNLEVBQUUsQ0FBQztZQUM5QixJQUFJLENBQUMsS0FBSyxHQUFHLEVBQUUsQ0FBQztZQUNoQixJQUFJLENBQUMsYUFBYSxHQUFHLEVBQUUsQ0FBQztZQUN4QixJQUFJLENBQUMsRUFBRSxHQUFHLElBQUksQ0FBQztZQUVmLEtBQUssQ0FBQyxJQUFJLENBQUMsWUFBWSxFQUFFLEVBQUU7Z0JBQ3pCLE1BQU0sRUFBRSxNQUFNO2dCQUNkLE9BQU8sRUFBRSxFQUFFLGNBQWMsRUFBRSxrQkFBa0IsRUFBRTthQUNoRCxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsUUFBUSxDQUFDLElBQUks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QUFDO2lCQUNuQjthQUNGO1FBQ0gsQ0FBQztLQUFBO0lBRUQsVUFBVTtRQUNSLE9BQU8sSUFBSSxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7WUFDckMsSUFBSSxJQUFJLENBQUMsRUFBRTtnQkFBRSxJQUFJLENBQUMsRUFBRSxDQUFDLEtBQUssRUFBRSxDQUFDO1lBQzdCLElBQUksQ0FBQyxTQUFTLEdBQUcsS0FBSyxDQUFDO1lBQ3ZCLElBQUksQ0FBQyxTQUFTLEdBQUcsRUFBRSxDQUFDO1lBQ3BCLElBQUksQ0FBQyxhQUFhLEdBQUcsRUFBRSxDQUFDO1lBQ3hCLElBQUksQ0FBQyxhQUFhLEdBQUcsRUFBRSxDQUFDO1lBQ3hCLElBQUksQ0FBQyxFQUFFLEdBQUcsSUFBSSxDQUFDO1lBQ2YsT0FBTyxFQUFFLENBQUM7UUFDWixDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCxZQUFZO1FBQ1YsT0FBTyxHQUFHLElBQUksQ0FBQyxTQUFTLHlCQUF5QixJQUFJLENBQUMsYUFBYSxjQUFjLENBQUE7SUFDbkYsQ0FBQztJQUVELFFBQVE7UUFDTixPQUFPLEdBQUcsSUFBSSxDQUFDLFNBQVMseUJBQXlCLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQTtJQUN2RSxDQUFDO0lBRUQsVUFBVSxDQUFDLElBQVk7UUFDckIsT0FBTyxHQUFHLElBQUksQ0FBQyxTQUFTLFdBQVcsSUFBSSxDQUFDLFNBQVMsVUFBVSxJQUFJLEVBQUUsQ0FBQTtJQUNuRSxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyB2NCBhcyB1dWlkdjQgfSBmcm9tICd1dWlkJztcbmltcG9ydCBTb2NrSlMgZnJvbSAnc29ja2pzLWNsaWVudCc7XG5pbXBvcnQgT3V0cHV0V3JpdGVyIGZyb20gJy4vb3V0cHV0LXdyaXRlcidcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQ2xpZW50IHtcbiAgc2VydmVyVXJsOiBzdHJpbmc7XG4gIGNvbm5lY3RlZDogYm9vbGVhbjtcbiAgc2Vzc2lvbklkOiBzdHJpbmc7XG4gIGNlbGxTZXNzaW9uSWQ6IHN0cmluZztcbiAgd3M6IGFueTtcbiAgcXVldWU6IHN0cmluZ1tdO1xuICBvdXRwdXRXcml0ZXJzOiBhbnk7XG5cbiAgY29uc3RydWN0b3Ioc2V0dGluZ3M6IGFueSkge1xuICAgIHRoaXMuc2VydmVyVXJsID0gc2V0dGluZ3Muc2VydmVyVXJsO1xuICAgIHRoaXMucXVldWUgPSBbXTtcbiAgICB0aGlzLm91dHB1dFdyaXRlcnMgPSB7fTtcbiAgfVxuXG4gIGNvbm5lY3QoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGlmICh0aGlzLmNvbm5lY3RlZCkgeyByZXR1cm4gcmVqZWN0KCk7IH1cblxuICAgICAgdGhpcy5jb25uZWN0ZWQgPSBmYWxzZTtcbiAgICAgIHRoaXMuc2Vzc2lvbklkID0gXCJcIjtcbiAgICAgIHRoaXMuY2VsbFNlc3Npb25JZCA9IHV1aWR2NCgpO1xuICAgICAgdGhpcy5xdWV1ZSA9IFtdO1xuICAgICAgdGhpcy5vdXRwdXRXcml0ZXJzID0ge307XG4gICAgICB0aGlzLndzID0gbnVsbDtcblxuICAgICAgZmV0Y2godGhpcy5nZXRLZXJuZWxVcmwoKSwge1xuICAgICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgICAgaGVhZGVyczogeyAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nIH1cbiAgICAgIH0pLnRoZW4ocmVzcG9uc2UgPT4gcmVzcG9uc2UuanNvbigpKVxuICAgICAgLnRoZW4oKGRhdGEpID0+IHtcbiAgICAgICAgdGhpcy5zZXNzaW9uSWQgPSBkYXRhLmlkO1xuICAgICAgICB0aGlzLndzID0gbmV3IFNvY2tKUyh0aGlzLmdldFdTVXJsKCkpO1xuICAgICAgICB0aGlzLndzLm9ub3BlbiA9ICgpID0+IHtcbiAgICAgICAgICB0aGlzLmNvbm5lY3RlZCA9IHRydWU7XG4gICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMud3Mub25tZXNzYWdlID0gKG1zZzogYW55KSA9PiB7IHRoaXMuaGFuZGxlUmVwbHkobXNnKTsgfVxuICAgICAgICB0aGlzLndzLm9uY2xvc2UgPSAoKSA9PiB7IHRoaXMuZGlzY29ubmVjdCgpOyB9XG4gICAgICAgIHRoaXMud3Mub25lcnJvciA9ICgpID0+IHsgdGhpcy5kaXNjb25uZWN0KCk7IH1cbiAgICAgIH0pLmNhdGNoKChlKSA9PiB7XG4gICAgICAgIHRoaXMuZGlzY29ubmVjdCgpO1xuICAgICAgICByZWplY3QoZSk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIGVucXVldWUoY29kZTogc3RyaW5nLCBvdXRwdXRFbDogSFRNTEVsZW1lbnQpIHtcbiAgICBjb25zdCBtc2dJZCA9IHV1aWR2NCgpO1xuICAgIGNvbnN0IHBheWxvYWQgPSBKU09OLnN0cmluZ2lmeSh7XG4gICAgICBoZWFkZXI6IHtcbiAgICAgICAgbXNnX2lkOiBtc2dJZCxcbiAgICAgICAgdXNlcm5hbWU6IFwiXCIsXG4gICAgICAgIHNlc3Npb246IHRoaXMuY2VsbFNlc3Npb25JZCxcbiAgICAgICAgbXNnX3R5cGU6ICdleGVjdXRlX3JlcXVlc3QnLFxuICAgICAgfSxcbiAgICAgIG1ldGFkYXRhOiB7fSxcbiAgICAgIGNvbnRlbnQ6IHtcbiAgICAgICAgY29kZTogY29kZSxcbiAgICAgICAgc2lsZW50OiBmYWxzZSxcbiAgICAgICAgdXNlcl92YXJpYWJsZXM6IFtdLFxuICAgICAgICB1c2VyX2V4cHJlc3Npb25zOiB7XG4gICAgICAgICAgXCJfc2FnZWNlbGxfZmlsZXNcIjogXCJzeXMuX3NhZ2VfLm5ld19maWxlcygpXCIsXG4gICAgICAgIH0sXG4gICAgICAgIGFsbG93X3N0ZGluOiBmYWxzZVxuICAgICAgfSxcbiAgICAgIHBhcmVudF9oZWFkZXI6IHt9XG4gICAgfSk7XG4gICAgdGhpcy5vdXRwdXRXcml0ZXJzW21zZ0lkXSA9IG5ldyBPdXRwdXRXcml0ZXIob3V0cHV0RWwpO1xuICAgIHRoaXMucXVldWUucHVzaChwYXlsb2FkKVxuICB9XG5cbiAgc2VuZCgpIHtcbiAgICBjb25zdCBwYXlsb2FkID0gdGhpcy5xdWV1ZS5zaGlmdCgpO1xuICAgIHRoaXMud3Muc2VuZChgJHt0aGlzLnNlc3Npb25JZH0vY2hhbm5lbHMsJHtwYXlsb2FkfWApO1xuICB9XG5cbiAgYXN5bmMgaGFuZGxlUmVwbHkobXNnOiBhbnkpIHtcbiAgICBjb25zdCBkYXRhID0gSlNPTi5wYXJzZShtc2cuZGF0YS5zdWJzdHJpbmcoNDYpKTtcbiAgICBjb25zdCBtc2dUeXBlID0gZGF0YS5oZWFkZXIubXNnX3R5cGU7XG4gICAgY29uc3QgbXNnSWQgPSBkYXRhLnBhcmVudF9oZWFkZXIubXNnX2lkO1xuICAgIGNvbnN0IGNvbnRlbnQgPSBkYXRhLmNvbnRlbnQ7XG4gICAgXG4gICAgaWYgKG1zZ1R5cGUgPT0gJ3N0cmVhbScgJiYgY29udGVudC50ZXh0KSB7XG4gICAgICB0aGlzLm91dHB1dFdyaXRlcnNbbXNnSWRdLmFwcGVuZFRleHQoY29udGVudC50ZXh0KTtcbiAgICB9XG4gICAgaWYgKG1zZ1R5cGUgPT0gJ2V4ZWN1dGVfcmVzdWx0JyAmJiBjb250ZW50LmRhdGFbJ3RleHQvcGxhaW4nXSkge1xuICAgICAgdGhpcy5vdXRwdXRXcml0ZXJzW21zZ0lkXS5hcHBlbmRUZXh0KGNvbnRlbnQuZGF0YVsndGV4dC9wbGFpbiddKTtcbiAgICB9XG4gICAgaWYgKG1zZ1R5cGUgPT0gJ2Rpc3BsYXlfZGF0YScgJiYgY29udGVudC5kYXRhWyd0ZXh0L2ltYWdlLWZpbGVuYW1lJ10pIHtcbiAgICAgIHRoaXMub3V0cHV0V3JpdGVyc1ttc2dJZF0uYXBwZW5kSW1hZ2UodGhpcy5nZXRGaWxlVXJsKGNvbnRlbnQuZGF0YVsndGV4dC9pbWFnZS1maWxlbmFtZSddKSk7XG4gICAgfVxuICAgIGlmIChtc2dUeXBlID09ICdkaXNwbGF5X2RhdGEnICYmIGNvbnRlbnQuZGF0YVsndGV4dC9odG1sJ10pIHtcbiAgICAgIHRoaXMub3V0cHV0V3JpdGVyc1ttc2dJZF0uYXBwZW5kU2FmZUhUTUwoY29udGVudC5kYXRhWyd0ZXh0L2h0bWwnXS5yZXBsYWNlKFwiY2VsbDovL1wiLCB0aGlzLmdldEZpbGVVcmwoXCJcIikpKTtcbiAgICB9XG4gICAgaWYgKG1zZ1R5cGUgPT0gJ2Vycm9yJykge1xuICAgICAgdGhpcy5vdXRwdXRXcml0ZXJzW21zZ0lkXS5hcHBlbmRFcnJvcihjb250ZW50KTtcbiAgICB9XG4gICAgaWYgKG1zZ1R5cGUgPT0gJ2V4ZWN1dGVfcmVwbHknKSB7XG4gICAgICBpZiAodGhpcy5xdWV1ZS5sZW5ndGggPiAwKSB7XG4gICAgICAgIHRoaXMuc2VuZCgpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5kaXNjb25uZWN0KCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgZGlzY29ubmVjdCgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgaWYgKHRoaXMud3MpIHRoaXMud3MuY2xvc2UoKTtcbiAgICAgIHRoaXMuY29ubmVjdGVkID0gZmFsc2U7XG4gICAgICB0aGlzLnNlc3Npb25JZCA9IFwiXCI7XG4gICAgICB0aGlzLmNlbGxTZXNzaW9uSWQgPSBcIlwiO1xuICAgICAgdGhpcy5vdXRwdXRXcml0ZXJzID0ge307XG4gICAgICB0aGlzLndzID0gbnVsbDtcbiAgICAgIHJlc29sdmUoKTtcbiAgICB9KTtcbiAgfVxuXG4gIGdldEtlcm5lbFVybCgpOiBzdHJpbmcge1xuICAgIHJldHVybiBgJHt0aGlzLnNlcnZlclVybH0va2VybmVsP0NlbGxTZXNzaW9uSUQ9JHt0aGlzLmNlbGxTZXNzaW9uSWR9JnRpbWVvdXQ9aW5mYFxuICB9XG5cbiAgZ2V0V1NVcmwoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gYCR7dGhpcy5zZXJ2ZXJVcmx9L3NvY2tqcz9DZWxsU2Vzc2lvbklEPSR7dGhpcy5jZWxsU2Vzc2lvbklkfWBcbiAgfVxuXG4gIGdldEZpbGVVcmwoZmlsZTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICByZXR1cm4gYCR7dGhpcy5zZXJ2ZXJVcmx9L2tlcm5lbC8ke3RoaXMuc2Vzc2lvbklkfS9maWxlcy8ke2ZpbGV9YFxuICB9XG59Il19